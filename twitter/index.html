<html>
  
<body>
<p>
This is a test page to test an integration with Twitter!
</p>
  <a href="https://twitter.com/share" class="twitter-share-button" data-via="penkin_v" data-hashtags="myhashtag">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  <script>
   var crypto = require('crypto'),
    http = require('http'),
    express = require('express'),
    expressSession = require('express-session'),
    bodyParser = require('body-parser'),
    cookieParser = require('cookie-parser'),
    methodOverride = require('method-override'),
    passport = require('passport'),
    TwitterStrategy = require('passport-twitter'),
    request = require('request');
 
 
// The Cxense API request setup
var username = 'vladimir.pekin@cxense.com';// TODO: Add your Cxense username here
var apiKey = 'api&user&pC/E3Msh/bEsdlGQsUaYTw==';  // TODO: Add your Cxense API key here
var prefix = 'q11';             // TODO: Add your Cxense customer prefix here
 
function cxApiRequest(apiName, body, callback) {
    var date = new Date().toISOString(), hmac = crypto.createHmac('sha256', apiKey).update(date).digest('hex');
    console.log('Sending API request: ' + apiName + ', body: ' + JSON.stringify(body));
    request.post({
        url: 'https://api.cxense.com' + apiName,
        headers: {'X-cXense-Authentication': 'username=' + username + ' date=' + date + ' hmac-sha256-hex=' + hmac},
        body: body,
        json: true
    }, callback);
}
 
 
// The Twitter sign-in setup (using Passport and Express)
 
// Passport session setup.
//   To support persistent login sessions, Passport needs to be able to
//   serialize users into and deserialize users out of the session.  Typically,
//   this will be as simple as storing the user ID when serializing, and finding
//   the user by ID when deserializing.  However, since this example does not
//   have a database of user records, the complete Google profile is
//   serialized and deserialized.
passport.serializeUser(function(user, done) {
    done(null, user);
});
 
passport.deserializeUser(function(obj, done) {
    done(null, obj);
});
 
passport.use(new TwitterStrategy({
        consumerKey: 'm39IP0LXmoIVW2VMEpQHo0YfH',          // TODO: Add your Twitter API key here
        consumerSecret: '4pnsOSFZXleWidYorNuSkNO8o7yh9D3Lld5O11I5wGTl3NENYU', // TODO: Add your Twitter API secret here
        callbackURL: 'https://cxensebot.cxense.com/auth/twitter/callback'
    },
    function(token, tokenSecret, profile, cb) {
        cb(null, profile);
    }
));
 
 
// Configure Express
var app = express();
var server = http.createServer(app);
app.set('port', 10520);
app.use(bodyParser.json());
app.use(cookieParser());
app.use(bodyParser.urlencoded({ extended: false }));
app.use(methodOverride());
app.use(expressSession({ secret: 'funny figure', resave: false, saveUninitialized: false }));
 
// Initialize Passport!  Also use passport.session() middleware, to support persistent login sessions (recommended).
app.use(passport.initialize());
app.use(passport.session());
 
 
app.get('/auth/twitter',
    passport.authenticate('twitter'));
 
app.get('/auth/twitter/callback',
    passport.authenticate('twitter', { failureRedirect: '/login.html' }),
    function(req, res) {
 
        // Successful authentication, link the user IDs and then redirect home.
        var cxenseId = req.cookies['cX_P'];
        var twitterId = req.user.id;
        console.log('Mapping user cxense ID: ' + cxenseId + ' and twitter ID: ' + twitterId);
 
        // The actual linking of IDs:
        cxApiRequest('/profile/user/external/link/update', { type: prefix, id: twitterId, cxid: cxenseId },
            function (error, response, body) {
                if (!error && response.statusCode === 200) {
                    console.log('Link update success!');
                } else {
                    console.log('Map error: ' + (error || response.statusCode))
                }
        });
 
        res.redirect('/');
    });
 
 
// Start server
server.listen(app.get('port'));
console.log('Listening on port ' + app.get('port'));
  </script>
    
</body>
</html>
